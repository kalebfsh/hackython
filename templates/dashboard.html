{% extends "base.html" %}
{% load static %}
{% block content %}
<h1>Your pet: <span id="pet-name">{{ pet.name }}</span></h1>
<div id="top-grid">
  <div class="left-column">
    <div id="pet-area">
      <img id="pet-img" src="{% static 'pets/'|add:pet.appearance|add:'.png' %}" alt="pet" width="200">
      <div id="pet-stats">
        Level: <span id="pet-level">{{ pet.level }}</span><br>
        Happiness: <span id="pet-happiness">{{ pet.happiness|floatformat:0 }}</span>
        Hunger: <span id="pet-hunger">{{ pet.hunger|floatformat:0 }}</span>
      </div>
    </div>

    <section id="rename">

      <h3>Rename your pet</h3>
      <form id="rename-form" method="post" action="{% url 'rename_pet' %}">
        {% csrf_token %}
        <input type="text" name="name" id="rename-input" value="{{ pet.name }}" maxlength="30" required>
        <button type="submit">Rename</button>
      </form>
      <div id="rename-message" style="color: #b00;"></div>
    </section>
  </div>

   <div class="right-column">
    <section id="food">
      <h3>Food</h3>

<!--      <div class="food-image-wrap">-->
<!--        <img src="/static/banana.png" alt="Fruit tree" class="food-tree">-->
<!--      </div>-->
      <p>Bananas collected: <span id="banana-counter">0</span></p>

  <!-- Banana growing area -->
      <div id="banana-area"></div>

      <div class="food-list">
        <button id="feed-banana">Feed: Banana</button>
<!--        <button id="feed-cookie">Feed: Cookie</button>-->

      </div>

    </section>
  </div>
</div>

<section id="checkin">
  <h2>How are you feeling?</h2>
  <form id="mood-form" method="post">
    {% csrf_token %}
    {{ form.value }} <span id="value-label">50</span><br>
    {{ form.note }}<br>
    <button type="submit">Check-in</button>
  </form>
  <div id="message"></div>
</section>


<section id="history">
  <button id="clear-log" type="button">Clear Log</button>
  <h3>Recent</h3>
  <ul style="list-style-position: inside;">
    {% for m in recent %}
      <li>{{ m.created_at|date:"M j H:i" }} â€” {{ m.value }} â€” {{ m.note|default:"" }}</li>
    {% empty %}
      <li>No entries yet</li>
    {% endfor %}
  </ul>
</section>

<canvas id="moodChart" width="600" height="400"></canvas>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const bananaArea = document.getElementById('banana-area');
const bananaCounterEl = document.getElementById('banana-counter');
let bananaCount = 0;
class Bananas{
  constructor(){
    this.count = 0;
  }
  add(){
    this.count++;
  }
  sub(){
    this.count--;
  }
  r(){
    return this.count;
  }
}

let bananas = new Bananas();

function spawnBanana(b) {

  if(b.r() >= 5){
    return 0;
  }
  b.add();
  const banana = document.createElement('img');
  banana.src = "{% static '/tree/banana.png' %}";
  banana.classList.add('banana'); // starts at width: 0

  // random position inside banana area
  const x = Math.random() * (bananaArea.clientWidth - 50);
  const y = Math.random() * (bananaArea.clientHeight - 50);
  banana.style.left = `${x}px`;
  banana.style.top = `${y}px`;

  bananaArea.appendChild(banana);

  // ðŸ‘‡ give the browser a tick before adding .grow
  setTimeout(() => {
    banana.classList.add('grow');
  }, 50);

  // clicking collects the banana
  banana.addEventListener('click', () => {
    bananas.sub();
    bananaCount++;
    bananaCounterEl.textContent = bananaCount;
    banana.remove();
  });
}

// spawn a new banana every 5 seconds
setInterval(() => spawnBanana(bananas), 5000);



// (optional) spawn one immediately on page load
spawnBanana();
</script>
<script>
  const moodDates = {{ mood_dates|safe }};
  const moodValues = {{ mood_values|safe }};
</script>
<script>
  const ctx = document.getElementById('moodChart').getContext('2d');

  const moodChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: moodDates,
        datasets: [{
            label: 'Mood Trend',
            data: moodValues,
            borderColor: 'blue',
            backgroundColor: 'lightblue',
            fill: true,
            tension: 0.3,
            pointRadius: 4
        }]
    },
    options: {
        responsive: true,
        scales: {
            x: { title: { display: true, text: 'Date' }, min: 0, max: 14 },
            y: { title: { display: true, text: 'Mood (1â€“100)' }, min: 0, max: 100 }
        }
    }
});
</script>

<script>
const valueInput = document.querySelector('input[name="value"]');
const valueLabel = document.getElementById('value-label');
const historyList = document.querySelector('#history ul');
const clearButton = document.getElementById('clear-log');
const form = document.getElementById('mood-form');

valueLabel.textContent = valueInput.value;
valueInput.addEventListener('input', e => valueLabel.textContent = e.target.value);

// Clear log
clearButton.addEventListener('click', async () => {
  if (!confirm("Are you sure you want to clear all moods?")) return;

  const resp = await fetch("{% url 'clear_log' %}", {
    method: 'POST',
    headers: {'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value},
  });

  if (resp.ok) {
    const data = await resp.json();
    if (data.success) {
      // Reset chart
      moodChart.data.labels = [];
      moodChart.data.datasets[0].data = [];
      moodChart.update();

      // Reset log
      historyList.innerHTML = '<li>No entries yet</li>';
    }
  } else {
    alert('Server error while clearing log.');
  }
});

// const historyList = document.querySelector('#history ul');
valueLabel.textContent = valueInput.value;
valueInput.addEventListener('input', e => valueLabel.textContent = e.target.value);

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(form);
  const resp = await fetch("{% url 'submit_mood' %}", {
    method: 'POST',
    headers: {'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value},
    body: formData
  });
  if (!resp.ok) {
    document.getElementById('message').textContent = 'Error saving mood';
    return;
  }
  const data = await resp.json();
  // In case saving mood fails:
  if (!data.success) {document.getElementById('message').textContent = 'Error saving mood'; return;}

  // update pet image and stats
  document.getElementById('pet-img').src = "{% static 'pets/' %}" + data.pet.appearance + ".png";
  document.getElementById('pet-level').textContent = data.pet.level;
  document.getElementById('pet-happiness').textContent = Math.round(data.pet.happiness);
  document.getElementById('message').textContent = 'Saved! Your pet seems ' + (data.pet.happiness>60 ? 'happy :)' : 'quiet.');
// Update chart
moodChart.data.labels = data.mood_dates;
moodChart.data.datasets[0].data = data.mood_values;
moodChart.update();

// Update log list
historyList.innerHTML = '';
for (let i = data.mood_dates.length - 1; i >= 0; i--) {
  const li = document.createElement('li');
  li.textContent = `${data.mood_dates[i]} â€” ${data.mood_values[i]} â€” ${data.mood_notes[i] || ''}`;
  historyList.appendChild(li);
}

// Clear note box
  const noteInput = document.querySelector('input[name="npte"], textarea[name="note"]');
  if (noteInput) noteInput.value = '';

});

// Rename pet handler
const renameForm = document.getElementById('rename-form');
const renameInput = document.getElementById('rename-input');
const renameMsg = document.getElementById('rename-message');
const petNameEl = document.getElementById('pet-name');

renameForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  renameMsg.textContent = '';
  const formData = new FormData(renameForm);
  const resp = await fetch(renameForm.action, {
    method: 'POST',
    headers: {'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value},
    body: formData
  });
  if (!resp.ok) {
    renameMsg.textContent = 'Error renaming pet';
    return;
  }
  const data = await resp.json();
  if (!data.success) {
    // Show first error message if available
    const errs = data.errors && data.errors.name ? data.errors.name : ['Rename failed'];
    renameMsg.textContent = errs[0];
    return;
  }
  petNameEl.textContent = data.pet.name;
});

 document.getElementById('feed-apple').addEventListener('click', () => feedPet('apple'));
document.getElementById('feed-cookie').addEventListener('click', () => feedPet('cookie'));

async function feedPet(food) {
  const resp = await fetch("{% url 'feed_pet' %}", {
    method: 'POST',
    headers: {'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value},
    body: new URLSearchParams({food})
  });
  if (!resp.ok) return alert('Error feeding pet.');
  const data = await resp.json();
  if (data.success) {
    // update UI
    document.getElementById('pet-happiness').textContent = Math.round(data.pet.happiness);
    // show hunger somewhere:
    if (!document.getElementById('pet-hunger')) {
        const hungerSpan = document.createElement('div');
        hungerSpan.id = 'pet-hunger';
        document.getElementById('pet-stats').appendChild(hungerSpan);
    }
    document.getElementById('pet-hunger').textContent = `Hunger: ${Math.round(data.pet.hunger)}`;
  }

</script>
{% endblock %}
